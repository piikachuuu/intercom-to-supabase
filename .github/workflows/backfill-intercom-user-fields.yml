name: Backfill Intercom user fields into replies

on:
  workflow_dispatch:
    inputs:
      batch_rows:
        description: "Max reply rows to scan per loop"
        required: false
        default: "3000"
      max_conversations:
        description: "Max unique conversations to process per run"
        required: false
        default: "1000"
      intercom_delay_ms:
        description: "Delay between Intercom calls (ms)"
        required: false
        default: "150"

  schedule:
    - cron: "17 10 * * *"

jobs:
  backfill:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      # Simple DB sanity check (no fragile parsing)
      - name: DB sanity check
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          echo "Checking replies columns..."
          psql "$SUPABASE_DB_URL" -c "select column_name from information_schema.columns where table_schema='public' and table_name='replies' order by 1;"

      - name: Run backfill
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          INTERCOM_ACCESS_TOKEN: ${{ secrets.INTERCOM_ACCESS_TOKEN }}
          BATCH_ROWS: ${{ github.event.inputs.batch_rows || '3000' }}
          MAX_CONVERSATIONS: ${{ github.event.inputs.max_conversations || '1000' }}
          INTERCOM_DELAY_MS: ${{ github.event.inputs.intercom_delay_ms || '150' }}
        run: node scripts/backfill-intercom-user-fields.js
