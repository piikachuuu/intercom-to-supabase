name: Backfill Intercom user fields into replies

on:
  workflow_dispatch:
    inputs:
      max_rows:
        description: "Max reply rows to process per run"
        required: false
        default: "2000"
      batch_size:
        description: "Supabase batch size"
        required: false
        default: "200"
  schedule:
    - cron: "17 10 * * *" # daily at 10:17 UTC (adjust if you want)

jobs:
  backfill:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Run backfill
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          INTERCOM_ACCESS_TOKEN: ${{ secrets.INTERCOM_ACCESS_TOKEN }}
          MAX_ROWS: ${{ github.event.inputs.max_rows || '2000' }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size || '200' }}
          INTERCOM_DELAY_MS: "150"
        run: node scripts/backfill-intercom-user-fields.js
